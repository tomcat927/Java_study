# 假如优化器走的索引不是预期中的索引怎么办

**<font style="color:#DF2A3F;background-color:rgb(252, 252, 252);">老规矩，学习某个知识点，先搞清楚为什么？在看怎么解决</font>**

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">为什么优化器可能选择非预期索引？</font>
#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1. 统计信息偏差 </font>**
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">优化器依赖</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">数据分布统计信息</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">进行成本估算：</font>

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">场景</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">表数据量剧增/剧减未更新统计信息</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">索引列数据分布不均（如90%都是同一状态）</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">后果</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">优化器误判扫描行数（Rows列）</font>

_**<font style="color:rgba(0, 0, 0, 0.4);background-color:rgb(252, 252, 252);">示例：实际扫描1万行，统计信息误判为100行，导致错误选择索引</font>**_

+ **<font style="color:rgb(64, 64, 64);">更新机制</font>**

| **<font style="color:rgb(64, 64, 64);">数据库</font>** | **<font style="color:rgb(64, 64, 64);">自动更新触发条件</font>** | **<font style="color:rgb(64, 64, 64);">手动更新命令</font>** |
| --- | --- | --- |
| <font style="color:rgb(64, 64, 64);">MySQL</font> | <font style="color:rgb(64, 64, 64);">表数据修改 > 10% + 重启</font> | `**<font style="color:rgb(64, 64, 64);background-color:rgb(236, 236, 236);">ANALYZE TABLE t</font>**` |
| <font style="color:rgb(64, 64, 64);">PostgreSQL</font> | <font style="color:rgb(64, 64, 64);">AUTOVACUUM 阈值 (默认20%修改)</font> | `**<font style="color:rgb(64, 64, 64);background-color:rgb(236, 236, 236);">VACUUM ANALYZE t</font>**` |
| **<font style="color:rgb(64, 64, 64);">关键隐患</font>**<font style="color:rgb(64, 64, 64);">：大表统计更新可能锁表，需在业务低峰执行</font> | | |


---

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2. 查询条件陷阱</font>**
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">SQL写法导致索引失效，但优化器仍然选择低效索引：</font>

| **<font style="color:rgba(0, 0, 0, 0.9);">陷阱类型</font>** | **<font style="color:rgba(0, 0, 0, 0.9);">案例</font>** | **<font style="color:rgba(0, 0, 0, 0.9);">优化器行为</font>** |
| :---: | :---: | :---: |
| <font style="color:rgba(0, 0, 0, 0.9);">隐式类型转换</font> | `<font style="color:rgba(0, 0, 0, 0.9);">WHERE varchar_col = 123</font>` | <font style="color:rgba(0, 0, 0, 0.9);">索引失效但仍出现在执行计划</font> |
| <font style="color:rgba(0, 0, 0, 0.9);">索引列函数操作</font> | `<font style="color:rgba(0, 0, 0, 0.9);">WHERE YEAR(create_time)=2023</font>` | <font style="color:rgba(0, 0, 0, 0.9);">索引无效但被选择</font> |
| `<font style="color:rgba(0, 0, 0, 0.9);">LIKE</font>`<font style="color:rgba(0, 0, 0, 0.9);">通配符开头</font> | `<font style="color:rgba(0, 0, 0, 0.9);">WHERE name LIKE '%apple%'</font>` | <font style="color:rgba(0, 0, 0, 0.9);">退化全表扫描</font> |
| `<font style="color:rgba(0, 0, 0, 0.9);">OR</font>`<font style="color:rgba(0, 0, 0, 0.9);">连接非索引列</font> | `<font style="color:rgba(0, 0, 0, 0.9);">WHERE indexed_id=1 OR name='A'</font>` | <font style="color:rgba(0, 0, 0, 0.9);">可能放弃索引</font> |


---

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">3. 索引设计缺陷</font>**
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">索引本身存在结构性问题：</font>

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">复合索引顺序错误</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>

```plsql
-- 现有索引
INDEX(status, create_time)
-- 但高频查询
WHERE create_time > '2023-01-01' AND status='paid'  
-- 优化器无法高效使用 create_time 范围扫描
```

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">缺失覆盖索引</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">查询需回表大量数据，优化器可能放弃索引扫描</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">冗余索引干扰</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">过多相似索引（如</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">idx_a</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">,</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">idx_a_b</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">）导致优化器选择错误</font>

---

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">4. 成本计算模型局限</font>**
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">优化器基于</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">成本估算</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">而非实际耗时：</font>

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">参数误差</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - `<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">random_page_cost</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">(PostgreSQL)</font>
    - `<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">innodb_stats_persistent_sample_pages</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);"> </font><font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">(MySQL)</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">硬件认知偏差</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">SSD环境仍用HDD默认成本参数</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">算法限制</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">MySQL对</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">IN</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">子查询可能错误选择全表扫描</font>

---

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">5. 环境干扰因素</font>**
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">外部因素导致误判：</font>

+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">Buffer Pool未预热</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：冷启动时优化器拒绝走索引</font>
+ **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">参数强制设置</font>**<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">：</font>
    - `<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">optimizer_switch</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">关闭索引下推(ICP)</font>
    - `<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">force index</font>`<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">残留导致后续执行计划混乱</font>

---

### <font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">系统化解决方案</font>
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">根据根因采取针对性措施：</font>

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">1. 解决统计信息问题</font>**
```plsql
-- MySQL (立即更新)
ANALYZE TABLE orders;

-- PostgreSQL (提升采样精度)
SET default_statistics_target = 1000;
VACUUM ANALYZE orders;
```

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">2. 修正查询写法</font>**
```plsql
/* 类型转换修复 */
-- 原: SELECT ... WHERE phone = 13800138000
SELECT ... WHERE phone = '13800138000'  -- 明确字符串类型

/* 函数操作改造 */
-- 原: SELECT ... WHERE DATE(create_time) = '2023-01-01'
SELECT ... 
WHERE create_time >= '2023-01-01 00:00:00' 
  AND create_time < '2023-01-02 00:00:00'

/* OR 条件解耦 处理NULL值*/ 
-- 原: WHERE indexed_id=1 OR name='A'
SELECT ... WHERE indexed_id = 1 
UNION ALL
SELECT ... WHERE name='A' 
  AND (indexed_id <> 1 OR indexed_id IS NULL)
```

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">3. 优化索引结构</font>**
```plsql
/* 重建复合索引顺序 */
-- 原索引：INDEX(status, create_time)
DROP INDEX idx_old ON orders;
CREATE INDEX idx_new ON orders(create_time, status);  -- 范围列前置

/* 添加覆盖索引 */
-- 高频查询：SELECT status, amount FROM orders WHERE user_id=?
CREATE INDEX idx_cover ON orders(user_id, status, amount);  -- 覆盖查询字段
```

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">4. 干预优化器决策</font>**
```plsql
# MySQL SSD优化 (my.cnf)
innodb_io_capacity=20000
innodb_read_io_threads=16
optimizer_switch='index_merge=on'

# PostgreSQL SSD优化 (postgresql.conf)
random_page_cost=1.1
effective_io_concurrency=200
```

#### **<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">5. 终极端解决方案</font>**
<font style="color:rgba(0, 0, 0, 0.9);background-color:rgb(252, 252, 252);">当所有优化无效时：</font>

```plsql
-- 创建虚拟计算列 + 函数索引
ALTER TABLE orders 
  ADD COLUMN create_date DATE AS (DATE(create_time)) VIRTUAL;
CREATE INDEX idx_func ON orders(create_date);  -- 对计算列创建索引

-- 业务层拆分查询：将复杂查询拆分为多个简单查询
```



> 更新: 2025-06-04 13:59:07  
> 原文: <https://www.yuque.com/tulingzhouyu/db22bv/qeat1hdm3ezznar9>