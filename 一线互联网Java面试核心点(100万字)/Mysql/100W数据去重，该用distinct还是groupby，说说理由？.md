# 100W数据去重，该用distinct还是group by，说说理由？

对于100万级别的数据去重，选择 `DISTINCT` 还是 `GROUP BY`，在**功能上（仅去重，不进行聚合运算）两者是等效的**，大多数现代数据库的查询优化器会将它们生成相似甚至相同的执行计划。然而，从**可读性和表达意图**的角度来看，`DISTINCT` 通常更胜一筹。以下是从不同的角度出发进行分析解答：

### <font style="color:#ECAA04;">功能等效性 (仅去重)</font>
+ `SELECT DISTINCT column1, column2, ... FROM orders;`
+ `SELECT column1, column2, ... FROM orders GROUP BY column1, column2, ...;`

这两条SQL语句在只获取唯一组合的列值时，返回的结果是完全相同的。

### <font style="color:#ECAA04;">表达意图和可读性</font>
+ `**DISTINCT**`: 这个关键字的语义非常直接——“**返回唯一的行**”。当你的主要目的是去重时，使用 `DISTINCT` 能更清晰地表达你的意图，代码也更易于理解。
+ `**GROUP BY**`: 这个子句的主要目的是**将数据分成多个组，并对每个组进行聚合操作**（如 `COUNT()`, `SUM()`, `AVG()` 等）。虽然在不使用聚合函数时，`GROUP BY` 可以达到去重的效果，但这并**<font style="color:#DF2A3F;">非其主要设计目的</font>**。如果读者看到 `GROUP BY`，通常会期望看到聚合函数。

**结论1：为了代码清晰和准确表达去重意图，优先推荐使用 **`**DISTINCT**`**。**

### <font style="color:#ECAA04;">性能考量 (100万数据量级)</font>
在100万数据量级下，性能是关键。

+ **查询优化器：** 现代数据库的查询优化器通常足够智能，能够识别出上述两种写法的等效性，并选择最优的执行计划。这意味着，在很多情况下，它们的实际性能表现可能几乎没有差异。
+ **执行计划：** 无论是 `DISTINCT` 还是 `GROUP BY`，去重操作通常涉及以下一种或多种底层操作： 
    - **排序 (Sorting):** 将所有数据按照去重列进行排序，然后遍历排序后的结果，只保留每组相同数据的第一条。如果数据量大到内存无法容纳，排序可能需要磁盘I/O（外部排序），这会比较慢。
    - **哈希 (Hashing):** 遍历数据，将列值组合计算哈希值并存入哈希表。如果哈希表中已存在相同的哈希值（并确认原始值相同），则丢弃当前行。哈希操作通常在内存中进行时效率较高。
+ **索引的影响：**
    - **如果去重的列上有合适的索引**（特别是覆盖索引，即索引包含了所有需要去重的列），数据库可能可以直接利用索引的有序性或结构来高效地提取唯一值，避免全表扫描和大规模排序/哈希。在这种情况下，无论用 `DISTINCT` 还是 `GROUP BY`，性能都会很好，并且差异可能更小。
    - **如果没有合适的索引**，数据库将不得不进行全表扫描，然后进行排序或哈希。这时性能开销会比较大。

**结论2：对于性能，更关键的因素是是否有合适的索引支持去重操作，以及数据库优化器如何选择执行计划，而不是 **`**DISTINCT**`** 和 **`**GROUP BY**`** 关键字本身的区别。在没有索引的情况下，两者都可能较慢。**

### `<font style="color:#ECAA04;">GROUP BY</font>`<font style="color:#ECAA04;"> 的扩展性</font>
如果你的需求不仅仅是去重，还需要基于这些唯一的组合进行聚合计算（例如，计算每个唯一组合出现的次数），那么 `GROUP BY` 是唯一的选择，并且更符合其设计意图。

+ 例如，找出重复的行并统计重复次数：

```plsql
SELECT column1, column2, COUNT(*) as occurrences
FROM your_table
GROUP BY column1, column2
HAVING COUNT(*) > 1;
```

 这种场景下 `DISTINCT` 无法直接实现。

### 总结与建议
对于100万数据去重（仅获取唯一行）：

1. **首选 **`**DISTINCT**`**：** 因为它在语义上更清晰地表达了“去重”的意图。
2. **性能通常相似：** 大多数现代数据库优化器会将两者处理成相似的执行计划，性能差异不大。
3. **关注索引：** 确保你希望去重的列上有合适的索引。这是提升性能的关键，远比纠结用 `DISTINCT` 还是 `GROUP BY` 更重要。对于100万行数据，没有索引的去重操作将会非常慢。
4. **实际测试：****最重要的永远是实际测试。** 使用你目标数据库的 `EXPLAIN` (或等效工具，如 `EXPLAIN ANALYZE`) 来查看两条语句的执行计划。比较它们的成本、是否使用了索引、以及实际执行时间。不同数据库、不同版本、不同数据分布和表结构都可能导致细微的性能差异。

**简而言之：为了代码可读性，用 **`**DISTINCT**`**，为了性能，确保有索引，并用 **`**EXPLAIN**`** 验证。**



> 更新: 2025-05-20 14:07:14  
> 原文: <https://www.yuque.com/tulingzhouyu/db22bv/zq0g635ig13pmu6w>